<html>
<head>
  <meta charset="utf-8">

  <!--ADD ALL CSS STYLE-SHEETS -->

  <link href="//netdna.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
  <link rel=stylesheet type=text/css href="{{ url_for('static', filename='up.css') }}">
  <link rel=stylesheet type=text/css href="{{ url_for('static', filename='upload.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='dropzone.css') }}">
  <link href="{{ url_for('static',filename= 'bootstrap.min.css')}}" rel="stylesheet">
  <link href="{{ url_for('static',filename= 'cornerstone.min.css')}}" rel="stylesheet">

  <!--ADD ALL JAVASCRIPTS -->


  <script src="//netdna.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"> </script>
  <script src="{{ url_for('static',filename= 'jquery.min.js')}}"></script>
  <script src="{{ url_for('static',filename= 'upla.js')}}" type="text/javascript"> </script>
  <script type="text/javascript" src="{{ url_for('static',filename= 'dropzone.js')}}" > </script>
  <script type="text/javascript" src="{{ url_for('static',filename= 'something.js')}}" > </script>
  <script src="{{ url_for('static',filename= 'cornerstone.min.js')}}"></script>
  <SCRIPT src="{{ url_for('static',filename= 'cornerstoneMath.min.js')}}"></SCRIPT>
  <SCRIPT src="{{ url_for('static',filename= 'cornerstoneTools.min.js')}}"></SCRIPT>

  <!-- include the dicomParser library as the WADO image loader depends on it -->
  <script src="{{ url_for('static',filename= 'dicomParser.min.js')}}"></script>

  <!-- include the cornerstoneWADOImageLoader library -->
  <script src="{{ url_for('static',filename= 'cornerstoneWADOImageLoader.js')}}"></script>

  <!-- uids -->
  <script src="{{ url_for('static',filename= 'uids.js')}}"></script>

  <!-- Lines ONLY required for this example to run without building the project -->
  <script src="{{ url_for('static',filename= 'initializeWebWorkers.js')}}"></script>


</head>
<body>

  <div class="container">
        <div class="panel panel-default">
        <div class="panel-heading"><strong>Dicom ==> CRAZY_BITMAP Converter</strong> <small>Upload Files</small> </div>


<div class="panel-body">



<table>
  <td><h4>Select files </h4>
  <form class="uploadform"  name="upload" method="POST" action="{{ url_for('uploader') }}" enctype = "multipart/form-data">
    <div class="form-inline">
    <div class="form-group">
      <table>
        <td>
          <input  type="file" id="file" name="file" >
          <td>


          <div>
          <div id="res">
            <div class="col-md-6">



            <div style="width:100px;height:100px;position:relative;color: white;"
                 oncontextmenu="return false"
                 class='disable-selection noIbar'
                 unselectable='on'
                 onselectstart='return false;'
                 onmousedown='return false;'>
                 <div id="dicomImage"
                      style="width:100px;height:100px;top:13px;left:0px; position:relative">

                 </div>
                 </div>

                   <!--{{ dropzone.create(action_view='uploader') }}   js-upload-files-->

                 </div>

          </div>

          <td>
            <button  type="submit"  name="submit" class="btn btn-sm btn-primary" id="js-upload" formaction="{{ url_for('upload') }}">

            Upload</button>

          <td>
            <td>

          <button  type="submit"  name="submit" class="btn btn-sm btn-primary" id="js-upload-submit">

          Convert and Download</button> </div>

          </div>


  </div>
</table>


  </form>
  <td>
  <td>
    <td>
    <img src="{{url_for('static', filename='dicom.png')}}" height="250px" width="250px" alt="No files uploaded">


  </div>


</table>

<h4>Or drag and drop files below</h4>
<div  id="drop-zone">
<form class="dropzone" id="mydropzone" action="{{ url_for('upload') }}" enctype = "multipart/form-data">

</form>


<div>
  <a href="{{ url_for('preview') }}" > CLICK HERE TO UPLOAD THE FILES </a>

</div>


  <footer>
    <div>
      <a href="{{ url_for('script_download') }}" > Wish to convert it back to .dcm?? Download our simple python script</a>

    </div>


  </footer>

          <script>
              cornerstoneWADOImageLoader.external.cornerstone = cornerstone;

              // this function gets called once the user drops the file onto the div
              function handleFileSelect(evt) {
                  evt.stopPropagation();
                  evt.preventDefault();

                  // Get the FileList object that contains the list of files that were dropped
                  const files = evt.dataTransfer.files;

                  // this UI is only built for a single file so just dump the first one
                  file = files[0];
                  const imageId = cornerstoneWADOImageLoader.wadouri.fileManager.add(file);
                  loadAndViewImage(imageId);
              }

              function handleDragOver(evt) {
                  evt.stopPropagation();
                  evt.preventDefault();
                  evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
              }

              // Setup the dnd listeners.
              const dropZone = document.getElementById('mydropzone');
              dropZone.addEventListener('dragover', handleDragOver, false);
              dropZone.addEventListener('drop', handleFileSelect, false);


              cornerstoneWADOImageLoader.configure({
                  beforeSend: function(xhr) {
                      // Add custom headers here (e.g. auth tokens)
                      //xhr.setRequestHeader('x-auth-token', 'my auth token');
                  },
                  useWebWorkers: true,
              });

              let loaded = false;

              function loadAndViewImage(imageId) {
                  const element = document.getElementById('dicomImage');

                  cornerstone.loadImage(imageId).then(function(image) {
                      console.log(image);
                      const viewport = cornerstone.getDefaultViewportForImage(element, image);


                      cornerstone.displayImage(element, image, viewport);
                      if(loaded === false) {
                          cornerstoneTools.mouseInput.enable(element);
                          cornerstoneTools.mouseWheelInput.enable(element);
                          cornerstoneTools.wwwc.activate(element, 1); // ww/wc is the default tool for left mouse button
                          cornerstoneTools.pan.activate(element, 2); // pan is the default tool for middle mouse button
                          cornerstoneTools.zoom.activate(element, 4); // zoom is the default tool for right mouse button
                          cornerstoneTools.zoomWheel.activate(element); // zoom is the default tool for middle mouse wheel


                          loaded = true;
                      }
                    }, function(err) {
                        alert("Seems like uploaded the wrong file");
                    });
                  }
                  cornerstone.events.addEventListener('cornerstoneimageloadprogress', function(event) {
                      const eventData = event.detail;
                      const loadProgress = document.getElementById('loadProgress');
                      loadProgress.textContent = `Image Load Progress: ${eventData.percentComplete}%`;
                  });

                  const element = document.getElementById('dicomImage');
                  cornerstone.enable(element);

                  document.getElementById('file').addEventListener('change', function(e) {
                      // Add the file to the cornerstoneFileImageLoader and get unique
                      // number for that file
                      const file = e.target.files[0];
                      const imageId = cornerstoneWADOImageLoader.wadouri.fileManager.add(file);
                      loadAndViewImage(imageId);
                  });

              </script>


</body>

</html>
